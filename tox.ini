[tox]
skipsdist = True
envlist = lint_all, testenv
# this needs to be defined on a single line.  tox has problems with multiline lists
# This list determined which adapters will be run by dbt centralized testing
supported_adapters = postgres, snowflake, redshift, bigquery

[testenv]
passenv =
    # postgres env vars
    POSTGRES_TEST_HOST
    POSTGRES_TEST_USER
    DBT_ENV_SECRET_POSTGRES_TEST_PASS
    POSTGRES_TEST_PORT
    POSTGRES_TEST_DBNAMEs
    POSTGRES_TEST_SCHEMA
    # snowflake env vars
    SNOWFLAKE_TEST_ACCOUNT
    SNOWFLAKE_TEST_USER
    DBT_ENV_SECRET_SNOWFLAKE_TEST_PASS
    SNOWFLAKE_TEST_ROLE
    SNOWFLAKE_TEST_DATABASE
    SNOWFLAKE_TEST_WAREHOUSE
    SNOWFLAKE_TEST_SCHEMA
    # redshift
    REDSHIFT_TEST_HOST
    REDSHIFT_TEST_USER
    DBT_ENV_SECRET_REDSHIFT_TEST_PASS
    REDSHIFT_TEST_DATABASE
    REDSHIFT_TEST_SCHEMA
    REDSHIFT_TEST_PORT
    # bigquery
    BIGQUERY_PROJECT
    DBT_ENV_SECRET_BIGQUERY_KEYFILE_JSON
    BIGQUERY_TEST_SCHEMA

# This is required to ensure that the correct adapters are tested
[testenv:list_supported_adapters]
allowlist_externals = echo
commands = echo {[tox]supported_adapters}

# Snowflake integration tests for centralized dbt testing
# run dbt commands directly, assumes dbt is already installed in environment
[testenv:dbt_integration_snowflake]
changedir = integration_tests
allowlist_externals = 
    dbt
skip_install = true
commands =
    dbt --warn-error deps --target snowflake
    dbt --warn-error run-operation create_source_table --target snowflake
    dbt --warn-error seed --target snowflake --full-refresh
    dbt --warn-error run --target snowflake
    dbt --warn-error test --target snowflake

# Postgres integration tests for centralized dbt testing
# run dbt commands directly, assumes dbt is already installed in environment
[testenv:dbt_integration_postgres]
changedir = integration_tests
allowlist_externals = 
    dbt
skip_install = true
commands =
    dbt --warn-error deps --target postgres
    dbt --warn-error run-operation create_source_table --target postgres
    dbt --warn-error seed --target postgres --full-refresh
    dbt --warn-error run --target postgres
    dbt --warn-error test --target postgres

# BigQuery integration tests for centralized dbt testing
[testenv:dbt_integration_bigquery]
changedir = integration_tests
allowlist_externals = 
    dbt
skip_install = true
commands =
    dbt --warn-error deps --target bigquery
    dbt --warn-error run-operation create_source_table --target bigquery
    dbt --warn-error seed --target bigquery --full-refresh
    dbt --warn-error run --target bigquery
    dbt --warn-error test --target bigquery

# redshift integration tests for centralized dbt testing
[testenv:dbt_integration_redshift]
changedir = integration_tests
allowlist_externals = 
    dbt
skip_install = true
commands =
    dbt --warn-error deps --target redshift
    dbt --warn-error run-operation create_source_table --target redshift
    dbt --warn-error seed --target redshift --full-refresh
    dbt --warn-error run --target redshift
    dbt --warn-error test --target redshift